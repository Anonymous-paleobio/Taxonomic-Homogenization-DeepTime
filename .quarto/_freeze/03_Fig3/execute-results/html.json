{
  "hash": "86eef52781f79c749fed7e92a1fffb52",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Generating Figure 3\"\ntitle-block-banner: \"#014240\"\ntitle-block-banner-color: \"#FFFFFF\"\ndate: last-modified\ndate-format: \"YYYY-MM-DD\"\nmainfont: Figtree\nsansfont: Figtree\nfootnotes-hover: true\nreference-location: margin\nlang: en\nnumber-sections: false\ncrossref:\n  chapters: true\nauthor:\n  - name: Anonymous\n    url: https://github.com/Anonymous-paleobio\nhighlight-style: pygments\nfig-cap-location: top\nformat:\n html:\n    toc: true\n    toc-expand: 5\n    toc-location: left\n    code-fold: true\n    html-math-method: katex\n    embed-resources: true\neditor_options: \n  chunk_output_type: console\n---\n\n## Setup\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrpkg <- c(\"readr tidyverse fs stringr ggplot2 dplyr conflicted piggyback tidyr tibble downloadthis ggpubr\")\n\n\nimport_pkg <- function(x)\n  x |> trimws() |> strsplit(\"\\\\s+\")  |> unlist() |> \n  lapply(function(x) library(x, character.only = T)) |> \n  invisible()\n\nrpkg |> import_pkg()\n\n# Resolve conflicted functions.\nconflicted::conflict_prefer(name = \"filter\", winner = \"dplyr\",losers = \"stats\")\n```\n:::\n\n\n## Multiple csv files\n\nWe begin by loading in the Jaccard .csv files we generated for each interval set in BeforeAfter.R. These files are also readily available for you in the Github Repository under the \"Difference\" folder.\n\nTo calculate the error and in Figure 3, we get the data from our calculations BeforeAfter as well, which is also readily available for you in the folder \"avg_diff\".\n\nRead multiple csv files in and organize them using `fs` to read in all the .csv files at once, as well as `purrr` and `dplyr` from `tidyverse` to organize them. We will do this for the main dataset and also for the grey error band we calculated earlier.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# For main dataset\ndata_dir <- \"~/Documents/BioHom/Difference/\" #setup directory of where we want to read the multiple files. This is simply folder of the sumRes_03 dataframe for each interval-set we've calculated, all collated into one folder. \n\n#For error band\ndata_diff <- \"~/Documents/BioHom/avg_diff/\"\n\n# Test to be sure this works by loading in all. csv files:\ncsv_files <- fs::dir_ls(data_dir, regexp = \"\\\\.csv$\")  # use fs to collect all data in data_dir that ends in .csv\ncsv_files_diff <- fs::dir_ls(data_diff, regexp = \"\\\\.csv$\") # for error\n\n# Now load in the .csv files and ID each .csv to keep tabs:\nall_Jacc <- data_dir |> \n  dir_ls(regexp = \"\\\\.csv$\") |>   # read in all files in the directory that end in .csv\n  map_dfr(read_csv, .id = \"source\")   # id everything by source\n#for errors:\nall_errors <- data_diff |> \n  dir_ls(regexp = \"\\\\.csv$\") |>   # read in all files in the directory that end in .csv\n  map_dfr(read_csv, .id = \"source\")   # id everything by source\n\n# Set up better ID's:\nall_Jacc$ID <- gsub(\".*\\\\/([^\\\\/]*)(Kpg|LOI|PT|TJ|lome|Messi|SanCamp|AlbCen|Pliens|Assel|Serra).*\", \"\\\\2\", all_Jacc$source)\n# ^ add a new column with ID's based on all_Jacc$source, removing all but the interval-pair name from it\n# Set up better ID's:\nall_errors$ID <- gsub(\".*\\\\/([^\\\\/]*)(Alb|Assel|Camp|Ceno|Cha|Dan|Dar|Het|Het|Hir|Ind|Kat|Maa|Messi|Ole|Plie|Rhae|Rhud|Sak|San|Toa|Zanc).*\", \"\\\\2\", all_errors$source)\n\n# Rearrange data for clarity using dplyr's arrange():\nall_Jacc <- all_Jacc |>   arrange(ID, cutdist)\nall_errors <- all_errors|>   arrange(ID, cutdist)\n\nall_Jacc$source <- NULL # remove source column now that it is no longer needed\nall_errors$source <- NULL # remove source column now that it is no longer needed\n\nall_Jacc$...1 <- NULL # remove this weird column that was added in with source as well\nall_errors$...1 <- NULL # remove this weird column that was added in with source as well\n\nall_Jacc$age <- NULL # remove this weird column that was added in with source as well\n\n# Separate the LOME and PT data for later:\n\n# After\nLOME_Jacc <- all_Jacc[all_Jacc$label == 'After' & all_Jacc$ID == 'lome', ]\nPT_Jacc   <- all_Jacc[all_Jacc$label == 'After' & all_Jacc$ID == 'PT', ]\n\n# After-2\nLOME2_Jacc <- all_Jacc[all_Jacc$label == 'After-2' & all_Jacc$ID == 'lome', ]\nPT2_Jacc   <- all_Jacc[all_Jacc$label == 'After-2' & all_Jacc$ID == 'PT', ]\n\n# Add in missing cutdist values:\nmissing_LOME <- data.frame(cutdist=c(18000, 20000),\n                           avg= c(NA, NA), sdev= c(NA, NA), \n                           n= c(NA,NA), se= c(NA,NA), first= c(NA,NA), \n                           second= c(NA, NA), label = c('After-2','After-2'),\n                           ci = c(NA, NA),\n                           ID = c('lome','lome'), Jaccard_change=c(NA,NA))\n\nLOME_Jacc <-rbind(LOME_Jacc, missing_LOME)\nLOME2_Jacc <- rbind(LOME2_Jacc, missing_LOME)\n\n# Add in missing cutdist values:\nmissing_PT <- data.frame(cutdist=c(18000, 18000,20000, 20000),\n                           avg= c(NA, NA, NA, NA),\n                          sdev= c(NA, NA, NA, NA),\n                           n=   c(NA, NA, NA, NA),\n                           se=  c(NA, NA, NA, NA),\n                         first= c(NA, NA, NA, NA),\n                        second= c(NA, NA, NA, NA),\n                        label = c('After','After-2', 'After', 'After-2'),\n                           ci = c(NA, NA, NA, NA),\n                           ID = c('PT','PT','PT', 'PT'),\n                        Jaccard_change=c(NA,NA,NA,NA))\n\nPT2_Jacc <- rbind(PT2_Jacc, missing_PT)\n\nLOME2_Jacc$ID <- 'LOME2' # Give it a unique label\nPT2_Jacc$ID <- 'PT2'\n\nLOME_Jacc <- rbind(LOME_Jacc, LOME2_Jacc) # Bring After and After-2 together\nPT_Jacc <- rbind(PT_Jacc, PT2_Jacc)\n```\n:::\n\n\n## Before and after columns\n\nAll interval pairs need to have columns from 0 -20000 in order to perform the calculations, so those with missing columns are filled in with NA data. We are separating by the labels Before and After. The goal is to create two new columns, one 'ave_before' and one 'ave_after' so we can subtract one from the other and calculate the change in similarity:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Using dplyr, I add each missing row into a new df: \nmissing <- data.frame(cutdist=c(20000, 20000, # AlbCen\n                                20000, 20000,# Assel\n                                20000, 20000, # LOI\n                                18000, 20000, # lome\n                                20000, 20000, # messi\n                                20000, 20000, # pliens\n                                18000, 18000, 20000, 20000, 20000, # PT\n                                20000, 20000, #SanCamp\n                                18000, 20000,  #Serra\n                                20000), #TJ\n                     avg=    c(NA, NA,\n                               NA, NA,\n                               NA, NA,\n                               NA, NA, \n                               NA, NA,\n                               NA, NA, \n                               NA, NA, NA, NA, NA,\n                               NA, NA,\n                               NA, NA, \n                               NA),\n                     sdev=   c(NA, NA, \n                               NA, NA,\n                               NA, NA,\n                               NA, NA, \n                               NA, NA, \n                               NA, NA, \n                               NA, NA, NA, NA, NA,\n                               NA, NA,\n                               NA, NA, \n                               NA),\n                     n=      c(NA, NA, \n                               NA, NA,\n                               NA, NA,\n                               NA, NA, \n                               NA, NA, \n                               NA, NA,\n                               NA, NA, NA, NA, NA,\n                               NA, NA,\n                               NA, NA, \n                               NA),\n                     se=     c(NA, NA, \n                               NA, NA,\n                               NA, NA,\n                               NA, NA, \n                               NA, NA, \n                               NA, NA,\n                               NA, NA, NA, NA, NA, \n                               NA, NA,\n                               NA, NA, \n                               NA),\n                     first=  c(NA, NA,\n                               NA, NA, \n                               NA, NA,\n                               NA, NA,  \n                               NA, NA, \n                               NA, NA, \n                               NA, NA, NA, NA, NA,\n                               NA, NA,\n                               NA, NA, \n                               NA), \n                     second= c(NA, NA, NA,\n                               NA,\n                               NA, NA, \n                               NA, NA, \n                               NA, NA,\n                               NA, NA, \n                               NA, NA, NA, NA, NA, \n                               NA, NA,\n                               NA, NA, \n                               NA),\n                     label=  c('Before', 'After',\n                               'Before', 'After',\n                               'Before', 'After',\n                               'After-2', 'After-2', \n                               'Before','After', \n                               'Before','After',\n                               'After', 'After-2', 'Before', \"After\", \"After-2\",\n                               'Before','After',\n                               'Before', 'After',\n                               'After'),\n                     ci=    c(NA, NA,\n                              NA, NA,\n                              NA, NA,\n                              NA, NA, \n                              NA, NA, \n                              NA, NA,\n                              NA, NA, NA, NA, NA, \n                              NA,NA,\n                              NA, NA, \n                              NA),\n                     ID =   c('AlbCen', 'AlbCen',\n                              'Assel', 'Assel',\n                              'LOI', 'LOI',\n                              'lome', 'lome',\n                              'Messi','Messi',\n                              'Pliens', 'Pliens', \n                              'PT', 'PT', 'PT', 'PT', 'PT',\n                              'SanCamp','SanCamp',\n                              'Serra', 'Serra',\n                              'TJ'),\n                     Jaccard_change= c(NA, NA,\n                              NA, NA,\n                              NA, NA,\n                              NA, NA, \n                              NA, NA, \n                              NA, NA,\n                              NA, NA, NA, NA, NA, \n                              NA,NA,\n                              NA, NA, \n                              NA))\n\n# Add these missing rows to the all_Jacc df\nall_Jacc <- rbind(all_Jacc, missing)\n\n# Rearrange all_Jacc by ID and cutDist and label\nall_Jacc <- all_Jacc |> \n            arrange(ID, cutdist, label)\n```\n:::\n\n\n## Difference\n\nSeparate the data to separate before and after columns so we can subtract them:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Remove After-2\nall_Jacc2 <- all_Jacc |> \n  filter(!label == 'After-2')\n\n# Before: \nbefore_data2 = \n  all_Jacc2 |>\n  filter(label == 'Before') |> \n  group_by(cutdist,ID) |>\n  mutate(ave_before = avg) |> \n  mutate(ave_first_b= first) |> \n  mutate(ave_second_b = second) |>\n  select(c(ave_before ))\n\n# After:\nafter_data2 = \n  all_Jacc2 |>\n  filter(label == 'After') |> \n  group_by(cutdist,ID) |>\n  mutate(ave_after = avg) |>\n    mutate(ave_first= first) |> \n  mutate(ave_second = second) |> #change the name to avg \n  select(c(ave_after)) # only these columns are selected\n\nbefore_data2 <- na.omit(before_data2)\nafter_data2 <- na.omit(after_data2)\n\n# Add the after_data to before_data:\nall_Jacc_diff2 <- left_join(after_data2, before_data2, by=c(\"cutdist\", \"ID\"))\n\n# Calculate the differences for avg:\nall_Jacc_diff<- all_Jacc_diff2 |> \n  mutate(Tavg_diff = ave_after - ave_before )  \n```\n:::\n\n\n## The interval-trio problem\n\nSince the LOME and PT have three intervals that we are analyzing, we need to treat it differently so we can calculate the difference. We will do much of what was done in the previous chunk to After-2 and apply it to find the difference between that and the After column.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Before: \nbefore_LOME = \n  LOME_Jacc |>\n  filter(label == 'After') |> \n  group_by(cutdist,ID) |>\n mutate(ave_before = avg) |>\n #change the name to avg \n  select(ave_before)\n\nbefore_PT = \n  PT_Jacc |>\n  filter(label == 'After') |> \n  group_by(cutdist,ID) |>\n mutate(ave_before = avg) |>\n select(ave_before)\n\n# After:\nafter_LOME = \n  LOME2_Jacc |>\n  group_by(cutdist,ID) |>\n  filter(label == 'After-2') |> \n mutate(ave_after = avg) |>\n #change the name to avg \n    ungroup() |> \n  select(ave_after) # only this column is selected\n\nafter_PT = \n  PT_Jacc |>\n  group_by(cutdist,ID) |>\n  filter(label == 'After-2') |> \n mutate(ave_after = avg) |>\nungroup() |> \n  select(ave_after) # only this column is selected\n\n# Add the after_data to before_data:\nLOME_Jacc <- cbind(before_LOME,after_LOME)\nLOME_Jacc$ID <- 'LOME2'\n\nPT_Jacc <- cbind(before_PT, after_PT)\nPT_Jacc$ID <- 'PT2'\n\n# Calculate the differences for avg:\nLOME_Jacc<- LOME_Jacc |> \n  mutate(Tavg_diff = ave_after - ave_before ) \n\n\nJacc <- rbind(all_Jacc_diff,LOME_Jacc)\n\nPT_Jacc <- PT_Jacc |> \n  mutate(Tavg_diff = ave_after - ave_before ) \n\nJacc <- rbind(Jacc,PT_Jacc)\n\n\n# Add a label to determine whether an interval is a mass extinction or background interval:\n\nJacc$mass <- NA\n\n#Using stringr's str_detect and dplyr's mutate, we can do this:\nJacc <- Jacc |> \n  mutate(mass = case_when(str_detect(ID, \"(lome|LOME2|PT|PT2|TJ|Kpg)$\")~ \"mass\", TRUE ~ \"background\")) #all else are labeled background\n```\n:::\n\n\nNow, here is the final dataset with all interval pairs and trios!\n\n\n::: {.cell}\n\n```{.r .cell-code}\nJacc\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 133 × 6\n# Groups:   cutdist, ID [133]\n   cutdist ID     ave_after ave_before Tavg_diff mass      \n     <dbl> <chr>      <dbl>      <dbl>     <dbl> <chr>     \n 1       0 AlbCen    0.0571     0.0417  0.0153   background\n 2    2000 AlbCen    0.0345     0.0222  0.0123   background\n 3    4000 AlbCen    0.0416     0.0435 -0.00194  background\n 4    6000 AlbCen    0.0240     0.0338 -0.00981  background\n 5    8000 AlbCen    0.0247     0.0258 -0.00110  background\n 6   10000 AlbCen    0.0210     0.0292 -0.00816  background\n 7   12000 AlbCen    0.0181     0.0241 -0.00595  background\n 8   14000 AlbCen    0.0246     0.0250 -0.000375 background\n 9   16000 AlbCen    0.0235     0.0212  0.00230  background\n10   18000 AlbCen    0.0112     0.0771 -0.0659   background\n# ℹ 123 more rows\n```\n\n\n:::\n:::\n\n\n## Finding the \"no-change\" zone\n\nFor this particular set of plots, we are going to want the dataframes of when we compare each age to itself (Changhsingian-to-Changhsingian, for example) instead of comparing before and after. Luckily, we already calculated that in the previous set of codes (`before_after.R`). From that code, we are interested in looking at the dataframes for each age that stored all our calculated similarity values for each iteration of our subsamples per age. We loaded that dataset in earlier in this script and labeled it *all_errors*, which gives the age as well as the maximumum and minimum values of those differences.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nall_errors\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 226 × 8\n   cutdist  mean_diff      sd     n       se lower_95 upper_95 ID   \n     <dbl>      <dbl>   <dbl> <dbl>    <dbl>    <dbl>    <dbl> <chr>\n 1       0 -0.00132   0.00751    99 0.000755  -0.0160  0.0134  Alb  \n 2    2000 -0.000565  0.00492    99 0.000495  -0.0102  0.00908 Alb  \n 3    4000 -0.000692  0.00844    99 0.000848  -0.0172  0.0159  Alb  \n 4    6000  0.000185  0.00661    99 0.000664  -0.0128  0.0131  Alb  \n 5    8000 -0.000686  0.00532    99 0.000535  -0.0111  0.00975 Alb  \n 6   10000  0.000160  0.00581    99 0.000584  -0.0112  0.0115  Alb  \n 7   12000 -0.000378  0.00548    99 0.000551  -0.0111  0.0104  Alb  \n 8   14000 -0.0000350 0.00629    99 0.000632  -0.0124  0.0123  Alb  \n 9   16000 -0.000755  0.00853    99 0.000857  -0.0175  0.0160  Alb  \n10   18000 -0.00788   0.0802     98 0.00810   -0.165   0.149   Alb  \n# ℹ 216 more rows\n```\n\n\n:::\n:::\n\n\nTo calculate the \"band of no-change\", We want to use the average of the upper and lower 95% confidence intervals for each distance bin (labeled as *cut_dist* here) across all the ages.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Upper 95 confidence interval:\nave_up95ci <- all_errors |>\n  group_by(cutdist) |>\n  summarise(upci = mean(upper_95, na.rm = TRUE)) |> \n  ungroup()\n\n# Lowe 95 confidence interval:\nave_low95ci <- all_errors |>\n  group_by(cutdist) |>\n  summarise(lowci = mean(lower_95, na.rm = TRUE)) |> \n  ungroup()\n\nciband <- left_join(ave_up95ci,ave_low95ci, by = \"cutdist\")\nciband$cutdist[is.na(ciband$cutdist)] <- 20000\n\n\n\nciband\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 11 × 3\n   cutdist   upci   lowci\n     <dbl>  <dbl>   <dbl>\n 1       0 0.0377 -0.0382\n 2    2000 0.0260 -0.0263\n 3    4000 0.0273 -0.0271\n 4    6000 0.0219 -0.0222\n 5    8000 0.0258 -0.0261\n 6   10000 0.0286 -0.0277\n 7   12000 0.0297 -0.0283\n 8   14000 0.0323 -0.0317\n 9   16000 0.0417 -0.0398\n10   18000 0.0598 -0.0592\n11   20000 0.0622 -0.0772\n```\n\n\n:::\n:::\n\n\n## Plot it out\n\nHere we create two plots to examine the change in similarity for each interval pair (or trio), as either a positive change representing trends towards homogenization, or a negative change representing change towards provincialization. The first plot is for background events and for intervals that directly succeed mass extinction events, so the Olenekian age which does not directly succeed the end-Permian mass extinction event is not included. The second plot investigates change in similarity across three subsequent ages for each of the Late Ordovician Mass Extinction (LOME) and for the end-Permian mass extinction events.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# background versus mass extinctions plot:\nall_Jacc_noOlen <- filter(Jacc, !(ID ==\"PT2\" ))\n\nPlot.allJacc <-  all_Jacc_noOlen |> \n  ggplot(aes(x = cutdist, \n             y = Tavg_diff,\n             group = ID, \n             colour = mass)) +     \n  geom_line(linewidth = 1.2, position = position_dodge(width = 0.3)) + \n  ylim(-0.25, 0.25) +\n  geom_hline(yintercept = 0, linewidth = 0.5) + \n  scale_color_manual(values = c(\"grey50\", \"#CC0033\")) +\n\n  labs(\n    x = \"Great Circle Distance (km)\",\n    y = \"Change in Similarity\", \n    colour = \"Extinction type\"\n  ) +\n  theme_light() +\n  geom_ribbon(\n    data = ciband, \n    aes(x = cutdist, ymin = lowci, ymax = upci), \n    fill = \"grey50\", \n    alpha = 0.3, \n    inherit.aes = FALSE, #use this or there will be an error\n  )+\n  theme(aspect.ratio = 1)\nPlot.allJacc\n```\n\n::: {.cell-output-display}\n![](03_Fig3_files/figure-html/plot-1.png){width=672}\n:::\n\n```{.r .cell-code}\nggsave(\"plot.allJacc.pdf\", plot = Plot.allJacc, width = 10, height =6 , units = \"in\", dpi = 300)\n\nall_Jacc3 <- Jacc |>   filter(ID %in% c(\"PT\", \"lome\", \"LOME2\", \"PT2\"))\n\n\n# LOME and PT interval-trio plot: \nPlot.Jacc3 <- all_Jacc3 |> \n  ggplot(aes(x = cutdist, \n             y = Tavg_diff,\n             group = ID, \n             colour = ID)) +     \n  geom_line(linewidth = 1.2, position = position_dodge(width = 0.3)) + ylim(-0.25, 0.25) +\n  geom_hline(yintercept=0, linewidth=0.5) + \nscale_color_manual(values = c( \"chocolate4\",\"tan2\", \"dodgerblue2\",\"skyblue2\")) +\n   geom_ribbon(\n    data = ciband, \n    aes(x = cutdist, ymin = lowci, ymax = upci), \n    fill = \"grey50\", \n    alpha = 0.3, \n    inherit.aes = FALSE\n  )+\nlabs(x = \"Great Circle Distance (km)\",\n     y = \"Change in Similarity\", \n     colour = \"Extinction type\") +\n  theme_light() +\n  theme(plot.title = element_text(face = \"bold\"),\n        axis.title = element_text(face = \"bold\"),\n        legend.title = element_text(face = \"bold\"),\n        aspect.ratio = 1)\nPlot.Jacc3\n```\n\n::: {.cell-output-display}\n![](03_Fig3_files/figure-html/plot-2.png){width=672}\n:::\n\n```{.r .cell-code}\nggsave(\"plot.Jaccwaste-pt.pdf\", plot = Plot.Jacc3, width = 10, height =6 , units = \"in\", dpi = 300)\n```\n:::\n\n",
    "supporting": [
      "03_Fig3_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}