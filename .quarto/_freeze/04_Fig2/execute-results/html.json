{
  "hash": "7dc909c685fcac58c421dd4d183276ce",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Generating Figure 2 - Phanerozoic Climate Stripes\"\ntitle-block-banner: \"#014240\"\ntitle-block-banner-color: \"#FFFFFF\"\ndate: last-modified\ndate-format: \"YYYY-MM-DD\"\nmainfont: Figtree\nsansfont: Figtree\nfootnotes-hover: true\nreference-location: margin\nlang: en\nnumber-sections: false\ncrossref:\n  chapters: true\nauthor:\n  - name: Anonymous\n    url: https://github.com/Anonymous-paleobio\nhighlight-style: pygments\nfig-cap-location: top\nformat:\n html:\n    toc: true\n    toc-expand: 5\n    toc-location: left\n    code-fold: true\n    html-math-method: katex\n    embed-resources: true\neditor_options: \n  chunk_output_type: console\n---\n\n## Climate Stripes\n\nLoad in the dataset from the Supplementary Materials of *Scotese (2021)*, which has the average global temperature per million years. In that file, you should calculate the average temperature per geologic age. If you can't do that, then no worries! The file *Scotese_intervalT.csv* is made available in Github for you to use and has all the information needed for this script.\n\n\\\nThe following block of code creates two plots: The first is a climate stripe of Global Average Temperature (in degrees C) per geologic age, and the second is a climate stripe of climate *change* per geologic age (e.g., the Induan age became 5 degrees warmer than its previous age, the Changhsingian):\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse) #(to use |> and to code more cleanly)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.1     ✔ stringr   1.6.0\n✔ ggplot2   4.0.0     ✔ tibble    3.3.0\n✔ lubridate 1.9.4     ✔ tidyr     1.3.1\n✔ purrr     1.2.0     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code}\nTemps <- read.csv(file='~/Documents/BioHom/Temperature-change/Scotese_intervalT.csv')\nTemps <- Temps |> select (-c(ScoteseAge, GAT,T_change_1 )) #remove unwanted columns\nTemps <- na.omit(Temps)\n        \n# Make the values numeric,except for the age number, which is factor\nTemps$ave_T <- as.numeric(Temps$ave_T)\nTemps$T_change <- as.numeric(Temps$T_change)\nTemps <- Temps[order(-Temps$Age), ]  #this will reverse the x axis\nTemps$Age <- factor(Temps$Age, levels =(Temps$Age)) # make it go in sequential order\n\n# Draw the plot:\nlibrary(ggplot2)\nphan_climate<- Temps |> \n  ggplot(aes(x = factor(Age), y = 1, fill = ave_T)) +\n  geom_tile() +\n  theme_void() +\n  theme(legend.position = \"none\") +\n  labs(title = \"Mean Global Temperature by Age (°C)\")+\n  scale_fill_gradient2(\n    low = \"#39A9C9\",     # Cooler than 18\n    mid = \"#F8F8FF\",        # Exactly 18\n    high = \"red3\",            # Warmer than 18\n    midpoint = 18, \n    #18 degrees is the divide between icecaps and no icecaps in Scotese et al. (2021)\n    name = \"Global Ave Temp by Geologic (°C)\"\n  ) +\n   geom_text(aes(label = Age), y = 0.95, size = 2.5, angle = 90, vjust = 1.5) +\n   # the above line adds labels to keep track of which stripe corresponds to which age\n  theme(\n    axis.text = element_blank(),\n    axis.ticks = element_blank(),\n    panel.grid = element_blank(),\n    legend.position = \"bottom\",\n    plot.margin = margin(20, 10, 40, 10) # Bottom space for custom labels\n  )\nphan_climate\n```\n\n::: {.cell-output-display}\n![](04_Fig2_files/figure-html/climate-1.png){width=672}\n:::\n\n```{.r .cell-code}\n # Make sure Ma is ordered and treated as a factor\nTemps$Ma <- factor(Temps$Age, levels = rev(levels(Temps$Age))) #levels = rev() will reverse the x axis\nTemps$T_change <- as.numeric(Temps$T_change)\n# Plot the climate stripes\n\nclimate_plot <- Temps |> \n  ggplot( aes(x = Age, y = 1, fill = T_change)) +\n  geom_tile() +\n  labs(title = \"Climate Change per Geologic Age\")+\n  scale_fill_gradient2(\n    low = \"#39A9C9\",       # For negative values\n    mid = \"#F8F8FF\",      # For zero\n    high = \"red3\",       # For positive values\n    midpoint = 0,       # Center the scale at 0\n    name = \"Climate Change (°C)\"\n  ) +\n  theme_void() +\n geom_text(aes(label = Age), y = 0.95, size = 2.5, angle = 90, vjust = 1.5) +\n  labs(title = \"T Change by Geologic Age\") +\n  theme(\n    axis.text = element_blank(),\n    axis.ticks = element_blank(),\n    panel.grid = element_blank(),\n    legend.position = \"bottom\",\n    aspect.ratio = 0.25, # get the ratio of plot defined so it matches with the Foote bars \n     plot.margin = margin(20, 10, 40, 10) # Bottom space for custom labels\n  )\nclimate_plot\n```\n\n::: {.cell-output-display}\n![](04_Fig2_files/figure-html/climate-2.png){width=672}\n:::\n\n```{.r .cell-code}\nggsave(\"phan_climate.pdf\", plot = phan_climate, width = 8, height = 6, dpi = 300)\nggsave(\"climate-plot.pdf\", plot = climate_plot, width = 8, height = 6, dpi = 300)\n```\n:::\n\n\n## Foote's calculation of per-capita extinction rate\n\nNet we calculate Foote's per-capita extinction rate using the simple equation from his 2000 publication. This was the gray portion of Figure 1, which was overlaid on the climate stripe:\n\nNow, let's load in and clean the data. You can find the Pbdb .csv file in our Github repository as well.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#read in the Phanerozoic pbdb dataset\npbdb <-read.csv(file = '~/Documents/BioHom/pbdb.data.Nov2024.csv')\n\ninterval.ma    <-  pbdb |> \n  filter(!is.na(early_interval) & !is.na(min_ma)) |> \n  group_by(early_interval) |> \n summarise(min_ma = min(min_ma))\nnames(interval.ma) <-c(\"early_interval\", \"interval.ma\")\npbdb       <- merge(pbdb, interval.ma, by=c(\"early_interval\"))\n\n# round the digits to keep consistent\ninterval.ma <- interval.ma |> \n  mutate(\n    interval.ma = round(interval.ma, 3)\n  )\n\n\n# Find first and last occurrences and merge back into data frame, using min_ma column\nfadlad <- pbdb |> \n  group_by(accepted_name)  |> \n  summarise(\n    fadname = max(early_interval),\n    ladname = min(early_interval),\n    fad = max(interval.ma),\n    lad = min(interval.ma)\n  )\n\n# Round to correct number of digits:\nfadlad <- fadlad |> \n  mutate(\n    fad = round(fad, 3),\n    lad = round(lad, 3)\n  )\n\n\n# Merge fad and lad information into data frame\npbdb <- merge(pbdb, fadlad, by=c(\"accepted_name\"))\n\n# Add extinction/survivor binary variable\npbdb$ex <- 0\npbdb$ex[pbdb$interval.ma==pbdb$lad] <- 1\n\n# Select variables.\npbdb <- pbdb |> \n  select(any_of(c(\"interval.ma\",\"early_interval\",\"interval.ma\",\"fad\",\"lad\",\n                  \"accepted_name\",\"genus\",\"ex\",\"phylum\",\"class\",\n                  \"order\",\"family\",\"paleolat\",\"paleolng\",\"formation\",\"member\",\n                  \"occurrence_no\",\"collection_no\",\"collection_name\",\n                  \"reference_no\")))\n\n# Keep the classes analyzed in this study\npbdb <- pbdb |> \n     filter(class %in% c(\"Gastropoda\", \"Bivalvia\", \"Trilobita\", \"Rhynchonellata\", \"Strophomenata\", \"Anthozoa\"))\n \n library(CoordinateCleaner)\n# Identify Invalid Coordinates.\n  cl <- cc_val(pbdb, value = \"flagged\", lat=\"paleolat\", lon  =\"paleolng\") #flags incorrect coordinates\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nTesting coordinate validity\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nFlagged 37220 records.\n```\n\n\n:::\n\n```{.r .cell-code}\n  cl_rec <- pbdb[!cl,] #extract and check them\n  \n pbdb <- pbdb |> \n   cc_val(lat = \"paleolat\", lon=\"paleolng\") #remove them\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nTesting coordinate validity\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRemoved 37220 records.\n```\n\n\n:::\n\n```{.r .cell-code}\n# Use fossilbrush to clean taxonomic errors\n library(fossilbrush)\nb_ranks <- c(\"phylum\", \"class\", \"order\", \"family\", \"accepted_name\") #accepted_name is genus name\n\n# Define a list of suffixes to be used at each taxonomic level when scanning for synonyms\nb_suff = list(NULL, NULL, NULL, NULL, c(\"ina\", \"ella\", \"etta\"))\n\npbdb2 <- check_taxonomy(pbdb, suff_set = b_suff, ranks = b_ranks, verbose = FALSE,clean_name = TRUE, resolve_duplicates = TRUE, jump = 5)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nChecking formatting [1/4]\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n + cleaning names at rank phylum        \n + cleaning names at rank class        \n + cleaning names at rank order        \n + cleaning names at rank family        \n + cleaning names at rank accepted_name        \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nChecking spelling   [2/4]\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nChecking ranks      [3/4]\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nChecking taxonomy   [4/4]\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n + resolving duplicates at rank accepted_name      \n + resolving duplicates at rank family      \n + resolving duplicates at rank order      \n + resolving duplicates at rank class      \n```\n\n\n:::\n\n```{.r .cell-code}\n# resolves homonyms, and jump refers to which taxonomic rank is the highest we resolve to. jump = 5 will stop before phylum since phylum level usually has little error.\n\n# Extract PBDB data from obdb2 so we have the corrected taxa:\npbdb <- pbdb2$data[1:nrow(pbdb),]\n\n\npbdb_fulldata <- pbdb # keep a record of all pertinent information, just in case\n\n\n#write.csv(pbdb, file=('~/Desktop/BioHom/pbdb_biohom_phan_cleaned.csv'))\n```\n:::\n\n\nNow, we want to calculate Foote's rate of extinction: $$ q = -ln(\\frac{N_b}{N_{bt}}) $$ ...where $N_b$ = the number of taxa that originated before the time interval and crossed into it (boundary-crossers), and $N_{bt}$ = the number of taxa that cross into the interval and survive it.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create a matrix of age-pairs using interval.ma\n \nagepairs <- interval.ma |> \n  arrange(interval.ma) |> # arrange by age number\n  mutate(\n    next_interval.ma= lead(interval.ma), #get the age number of the next age\n    next_early_interval= lead(early_interval) #get the name of the next age\n  ) |> \n  filter(!is.na(next_interval.ma)) #remove final row which does not have a next age\n```\n:::\n\n\n### Get `Nb` and `Nbt`\n\n$N_{b}$ will be taxa that originated at or before `interval.ma`, and went extinct after or at `next_interval.ma`.\n\n$N_{bt}$ will be taxa that originated at or before `interval.ma`, and went extinct after `next_interval.ma`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nextinction_rate <- agepairs |> rowwise() |>  \n  # rowwise is a function in dplyr that treats each row as its own group, so operations inside mutate() or other functions are applied one row at a time, instead of the standard, which is one column at a time \n mutate(\n    Nb =  sum(fadlad$fad >= interval.ma      &   fadlad$lad <= next_interval.ma),\n  \n    Nbt = sum(fadlad$lad <  next_interval.ma &   fadlad$fad >= interval.ma),\n    q = ifelse(Nb > 0 & Nbt > 0, -log(Nbt / Nb), NA_real_) ) |> \n  ungroup()\n```\n:::\n\n\n## Foote plot:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nTemps$Ma <- as.numeric(as.character(Temps$Ma)) \nextinction_rate$interval.ma <- as.numeric(extinction_rate$interval.ma)\n\nextinction_sub <- extinction_rate |>\n  arrange(desc(interval.ma)) |> \n  mutate(interval_ma_factor = factor(interval.ma, levels = unique(interval.ma))) #convert interval.ma to factor so we can space each age evenly to match the climate stripe spacing \n\nextinction_plot <- ggplot(extinction_sub, aes(x = interval_ma_factor, y = q)) + geom_col(fill = \"gray50\", width=1) + \n   geom_text(    #label all ages with q > 0.3 # \n  aes(label = ifelse(q > 0.1, interval.ma, \"\")), \n vjust = -0.5,  size = 3 ) +\n  theme_void() + labs(title = \"\") + #\"Foote's Per Capita Extinction Rate\" \n  theme( axis.text.x = element_blank(), # hide x labels \n         axis.ticks.x = element_blank(), \n         plot.margin = margin(0, 10, 10, 10), \n         plot.title = element_text(hjust =), aspect.ratio = 0.5 )\n\nextinction_plot\n```\n\n::: {.cell-output-display}\n![](04_Fig2_files/figure-html/ext-plot-1.png){width=672}\n:::\n:::\n\n\n## Both plots together:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(patchwork)\nfoote_climate <- climate_plot / extinction_plot + plot_layout(heights = c(1, 2)) + plot_annotation(title = \"Climate Change StripsExtinction\")\n\nfoote_climate\n```\n\n::: {.cell-output-display}\n![](04_Fig2_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n",
    "supporting": [
      "04_Fig2_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}