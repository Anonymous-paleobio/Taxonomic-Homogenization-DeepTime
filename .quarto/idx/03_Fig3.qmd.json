{"title":"Generating Figure 3","markdown":{"yaml":{"title":"Generating Figure 3","title-block-banner":"#014240","title-block-banner-color":"#FFFFFF","date":"last-modified","date-format":"YYYY-MM-DD","mainfont":"Figtree","sansfont":"Figtree","footnotes-hover":true,"reference-location":"margin","lang":"en","number-sections":false,"crossref":{"chapters":true},"author":[{"name":"Anonymous","url":"https://github.com/Anonymous-paleobio"}],"highlight-style":"pygments","fig-cap-location":"top","format":{"html":{"toc":true,"toc-expand":5,"toc-location":"left","code-fold":true,"html-math-method":"katex","embed-resources":true}},"editor_options":{"chunk_output_type":"console"}},"headingText":"Setup","containsRefs":false,"markdown":"\n\n\n```{r setup, message = FALSE, warning = FALSE}\n\nrpkg <- c(\"readr tidyverse fs stringr ggplot2 dplyr conflicted piggyback tidyr tibble downloadthis ggpubr\")\n\n\nimport_pkg <- function(x)\n  x |> trimws() |> strsplit(\"\\\\s+\")  |> unlist() |> \n  lapply(function(x) library(x, character.only = T)) |> \n  invisible()\n\nrpkg |> import_pkg()\n\n# Resolve conflicted functions.\nconflicted::conflict_prefer(name = \"filter\", winner = \"dplyr\",losers = \"stats\")\n\n```\n\n## Multiple csv files\n\nWe begin by loading in the Jaccard .csv files we generated for each interval set in BeforeAfter.R. These files are also readily available for you in the Github Repository under the \"Difference\" folder.\n\nTo calculate the error and in Figure 3, we get the data from our calculations BeforeAfter as well, which is also readily available for you in the folder \"avg_diff\".\n\nRead multiple csv files in and organize them using `fs` to read in all the .csv files at once, as well as `purrr` and `dplyr` from `tidyverse` to organize them. We will do this for the main dataset and also for the grey error band we calculated earlier.\n\n```{r multiple-csv, message = FALSE}\n\n# For main dataset\ndata_dir <- \"~/Documents/BioHom/Difference/\" #setup directory of where we want to read the multiple files. This is simply folder of the sumRes_03 dataframe for each interval-set we've calculated, all collated into one folder. \n\n#For error band\ndata_diff <- \"~/Documents/BioHom/avg_diff/\"\n\n# Test to be sure this works by loading in all. csv files:\ncsv_files <- fs::dir_ls(data_dir, regexp = \"\\\\.csv$\")  # use fs to collect all data in data_dir that ends in .csv\ncsv_files_diff <- fs::dir_ls(data_diff, regexp = \"\\\\.csv$\") # for error\n\n# Now load in the .csv files and ID each .csv to keep tabs:\nall_Jacc <- data_dir |> \n  dir_ls(regexp = \"\\\\.csv$\") |>   # read in all files in the directory that end in .csv\n  map_dfr(read_csv, .id = \"source\")   # id everything by source\n#for errors:\nall_errors <- data_diff |> \n  dir_ls(regexp = \"\\\\.csv$\") |>   # read in all files in the directory that end in .csv\n  map_dfr(read_csv, .id = \"source\")   # id everything by source\n\n# Set up better ID's:\nall_Jacc$ID <- gsub(\".*\\\\/([^\\\\/]*)(Kpg|LOI|PT|TJ|lome|Messi|SanCamp|AlbCen|Pliens|Assel|Serra).*\", \"\\\\2\", all_Jacc$source)\n# ^ add a new column with ID's based on all_Jacc$source, removing all but the interval-pair name from it\n# Set up better ID's:\nall_errors$ID <- gsub(\".*\\\\/([^\\\\/]*)(Alb|Assel|Camp|Ceno|Cha|Dan|Dar|Het|Het|Hir|Ind|Kat|Maa|Messi|Ole|Plie|Rhae|Rhud|Sak|San|Toa|Zanc).*\", \"\\\\2\", all_errors$source)\n\n# Rearrange data for clarity using dplyr's arrange():\nall_Jacc <- all_Jacc |>   arrange(ID, cutdist)\nall_errors <- all_errors|>   arrange(ID, cutdist)\n\nall_Jacc$source <- NULL # remove source column now that it is no longer needed\nall_errors$source <- NULL # remove source column now that it is no longer needed\n\nall_Jacc$...1 <- NULL # remove this weird column that was added in with source as well\nall_errors$...1 <- NULL # remove this weird column that was added in with source as well\n\nall_Jacc$age <- NULL # remove this weird column that was added in with source as well\n\n# Separate the LOME and PT data for later:\n\n# After\nLOME_Jacc <- all_Jacc[all_Jacc$label == 'After' & all_Jacc$ID == 'lome', ]\nPT_Jacc   <- all_Jacc[all_Jacc$label == 'After' & all_Jacc$ID == 'PT', ]\n\n# After-2\nLOME2_Jacc <- all_Jacc[all_Jacc$label == 'After-2' & all_Jacc$ID == 'lome', ]\nPT2_Jacc   <- all_Jacc[all_Jacc$label == 'After-2' & all_Jacc$ID == 'PT', ]\n\n# Add in missing cutdist values:\nmissing_LOME <- data.frame(cutdist=c(18000, 20000),\n                           avg= c(NA, NA), sdev= c(NA, NA), \n                           n= c(NA,NA), se= c(NA,NA), first= c(NA,NA), \n                           second= c(NA, NA), label = c('After-2','After-2'),\n                           ci = c(NA, NA),\n                           ID = c('lome','lome'), Jaccard_change=c(NA,NA))\n\nLOME_Jacc <-rbind(LOME_Jacc, missing_LOME)\nLOME2_Jacc <- rbind(LOME2_Jacc, missing_LOME)\n\n# Add in missing cutdist values:\nmissing_PT <- data.frame(cutdist=c(18000, 18000,20000, 20000),\n                           avg= c(NA, NA, NA, NA),\n                          sdev= c(NA, NA, NA, NA),\n                           n=   c(NA, NA, NA, NA),\n                           se=  c(NA, NA, NA, NA),\n                         first= c(NA, NA, NA, NA),\n                        second= c(NA, NA, NA, NA),\n                        label = c('After','After-2', 'After', 'After-2'),\n                           ci = c(NA, NA, NA, NA),\n                           ID = c('PT','PT','PT', 'PT'),\n                        Jaccard_change=c(NA,NA,NA,NA))\n\nPT2_Jacc <- rbind(PT2_Jacc, missing_PT)\n\nLOME2_Jacc$ID <- 'LOME2' # Give it a unique label\nPT2_Jacc$ID <- 'PT2'\n\nLOME_Jacc <- rbind(LOME_Jacc, LOME2_Jacc) # Bring After and After-2 together\nPT_Jacc <- rbind(PT_Jacc, PT2_Jacc)\n\n\n```\n\n## Before and after columns\n\nAll interval pairs need to have columns from 0 -20000 in order to perform the calculations, so those with missing columns are filled in with NA data. We are separating by the labels Before and After. The goal is to create two new columns, one 'ave_before' and one 'ave_after' so we can subtract one from the other and calculate the change in similarity:\n\n```{r}\n\n# Using dplyr, I add each missing row into a new df: \nmissing <- data.frame(cutdist=c(20000, 20000, # AlbCen\n                                20000, 20000,# Assel\n                                20000, 20000, # LOI\n                                18000, 20000, # lome\n                                20000, 20000, # messi\n                                20000, 20000, # pliens\n                                18000, 18000, 20000, 20000, 20000, # PT\n                                20000, 20000, #SanCamp\n                                18000, 20000,  #Serra\n                                20000), #TJ\n                     avg=    c(NA, NA,\n                               NA, NA,\n                               NA, NA,\n                               NA, NA, \n                               NA, NA,\n                               NA, NA, \n                               NA, NA, NA, NA, NA,\n                               NA, NA,\n                               NA, NA, \n                               NA),\n                     sdev=   c(NA, NA, \n                               NA, NA,\n                               NA, NA,\n                               NA, NA, \n                               NA, NA, \n                               NA, NA, \n                               NA, NA, NA, NA, NA,\n                               NA, NA,\n                               NA, NA, \n                               NA),\n                     n=      c(NA, NA, \n                               NA, NA,\n                               NA, NA,\n                               NA, NA, \n                               NA, NA, \n                               NA, NA,\n                               NA, NA, NA, NA, NA,\n                               NA, NA,\n                               NA, NA, \n                               NA),\n                     se=     c(NA, NA, \n                               NA, NA,\n                               NA, NA,\n                               NA, NA, \n                               NA, NA, \n                               NA, NA,\n                               NA, NA, NA, NA, NA, \n                               NA, NA,\n                               NA, NA, \n                               NA),\n                     first=  c(NA, NA,\n                               NA, NA, \n                               NA, NA,\n                               NA, NA,  \n                               NA, NA, \n                               NA, NA, \n                               NA, NA, NA, NA, NA,\n                               NA, NA,\n                               NA, NA, \n                               NA), \n                     second= c(NA, NA, NA,\n                               NA,\n                               NA, NA, \n                               NA, NA, \n                               NA, NA,\n                               NA, NA, \n                               NA, NA, NA, NA, NA, \n                               NA, NA,\n                               NA, NA, \n                               NA),\n                     label=  c('Before', 'After',\n                               'Before', 'After',\n                               'Before', 'After',\n                               'After-2', 'After-2', \n                               'Before','After', \n                               'Before','After',\n                               'After', 'After-2', 'Before', \"After\", \"After-2\",\n                               'Before','After',\n                               'Before', 'After',\n                               'After'),\n                     ci=    c(NA, NA,\n                              NA, NA,\n                              NA, NA,\n                              NA, NA, \n                              NA, NA, \n                              NA, NA,\n                              NA, NA, NA, NA, NA, \n                              NA,NA,\n                              NA, NA, \n                              NA),\n                     ID =   c('AlbCen', 'AlbCen',\n                              'Assel', 'Assel',\n                              'LOI', 'LOI',\n                              'lome', 'lome',\n                              'Messi','Messi',\n                              'Pliens', 'Pliens', \n                              'PT', 'PT', 'PT', 'PT', 'PT',\n                              'SanCamp','SanCamp',\n                              'Serra', 'Serra',\n                              'TJ'),\n                     Jaccard_change= c(NA, NA,\n                              NA, NA,\n                              NA, NA,\n                              NA, NA, \n                              NA, NA, \n                              NA, NA,\n                              NA, NA, NA, NA, NA, \n                              NA,NA,\n                              NA, NA, \n                              NA))\n\n# Add these missing rows to the all_Jacc df\nall_Jacc <- rbind(all_Jacc, missing)\n\n# Rearrange all_Jacc by ID and cutDist and label\nall_Jacc <- all_Jacc |> \n            arrange(ID, cutdist, label)\n\n\n```\n\n## Difference\n\nSeparate the data to separate before and after columns so we can subtract them:\n\n```{r, message = FALSE }\n\n# Remove After-2\nall_Jacc2 <- all_Jacc |> \n  filter(!label == 'After-2')\n\n# Before: \nbefore_data2 = \n  all_Jacc2 |>\n  filter(label == 'Before') |> \n  group_by(cutdist,ID) |>\n  mutate(ave_before = avg) |> \n  mutate(ave_first_b= first) |> \n  mutate(ave_second_b = second) |>\n  select(c(ave_before ))\n\n# After:\nafter_data2 = \n  all_Jacc2 |>\n  filter(label == 'After') |> \n  group_by(cutdist,ID) |>\n  mutate(ave_after = avg) |>\n    mutate(ave_first= first) |> \n  mutate(ave_second = second) |> #change the name to avg \n  select(c(ave_after)) # only these columns are selected\n\nbefore_data2 <- na.omit(before_data2)\nafter_data2 <- na.omit(after_data2)\n\n# Add the after_data to before_data:\nall_Jacc_diff2 <- left_join(after_data2, before_data2, by=c(\"cutdist\", \"ID\"))\n\n# Calculate the differences for avg:\nall_Jacc_diff<- all_Jacc_diff2 |> \n  mutate(Tavg_diff = ave_after - ave_before )  \n\n```\n\n## The interval-trio problem\n\nSince the LOME and PT have three intervals that we are analyzing, we need to treat it differently so we can calculate the difference. We will do much of what was done in the previous chunk to After-2 and apply it to find the difference between that and the After column.\n\n```{r LOME-2, message = FALSE }\n# Before: \nbefore_LOME = \n  LOME_Jacc |>\n  filter(label == 'After') |> \n  group_by(cutdist,ID) |>\n mutate(ave_before = avg) |>\n #change the name to avg \n  select(ave_before)\n\nbefore_PT = \n  PT_Jacc |>\n  filter(label == 'After') |> \n  group_by(cutdist,ID) |>\n mutate(ave_before = avg) |>\n select(ave_before)\n\n# After:\nafter_LOME = \n  LOME2_Jacc |>\n  group_by(cutdist,ID) |>\n  filter(label == 'After-2') |> \n mutate(ave_after = avg) |>\n #change the name to avg \n    ungroup() |> \n  select(ave_after) # only this column is selected\n\nafter_PT = \n  PT_Jacc |>\n  group_by(cutdist,ID) |>\n  filter(label == 'After-2') |> \n mutate(ave_after = avg) |>\nungroup() |> \n  select(ave_after) # only this column is selected\n\n# Add the after_data to before_data:\nLOME_Jacc <- cbind(before_LOME,after_LOME)\nLOME_Jacc$ID <- 'LOME2'\n\nPT_Jacc <- cbind(before_PT, after_PT)\nPT_Jacc$ID <- 'PT2'\n\n# Calculate the differences for avg:\nLOME_Jacc<- LOME_Jacc |> \n  mutate(Tavg_diff = ave_after - ave_before ) \n\n\nJacc <- rbind(all_Jacc_diff,LOME_Jacc)\n\nPT_Jacc <- PT_Jacc |> \n  mutate(Tavg_diff = ave_after - ave_before ) \n\nJacc <- rbind(Jacc,PT_Jacc)\n\n\n# Add a label to determine whether an interval is a mass extinction or background interval:\n\nJacc$mass <- NA\n\n#Using stringr's str_detect and dplyr's mutate, we can do this:\nJacc <- Jacc |> \n  mutate(mass = case_when(str_detect(ID, \"(lome|LOME2|PT|PT2|TJ|Kpg)$\")~ \"mass\", TRUE ~ \"background\")) #all else are labeled background\n```\n\nNow, here is the final dataset with all interval pairs and trios!\n\n```{r}\nJacc\n\n\n```\n\n## Finding the \"no-change\" zone\n\nFor this particular set of plots, we are going to want the dataframes of when we compare each age to itself (Changhsingian-to-Changhsingian, for example) instead of comparing before and after. Luckily, we already calculated that in the previous set of codes (`before_after.R`). From that code, we are interested in looking at the dataframes for each age that stored all our calculated similarity values for each iteration of our subsamples per age. We loaded that dataset in earlier in this script and labeled it *all_errors*, which gives the age as well as the maximumum and minimum values of those differences.\n\n```{r errordata}\nall_errors\n\n```\n\nTo calculate the \"band of no-change\", We want to use the average of the upper and lower 95% confidence intervals for each distance bin (labeled as *cut_dist* here) across all the ages.\n\n```{r read-sumRes}\n# Upper 95 confidence interval:\nave_up95ci <- all_errors |>\n  group_by(cutdist) |>\n  summarise(upci = mean(upper_95, na.rm = TRUE)) |> \n  ungroup()\n\n# Lowe 95 confidence interval:\nave_low95ci <- all_errors |>\n  group_by(cutdist) |>\n  summarise(lowci = mean(lower_95, na.rm = TRUE)) |> \n  ungroup()\n\nciband <- left_join(ave_up95ci,ave_low95ci, by = \"cutdist\")\nciband$cutdist[is.na(ciband$cutdist)] <- 20000\n\n\n\nciband\n\n```\n\n## Plot it out\n\nHere we create two plots to examine the change in similarity for each interval pair (or trio), as either a positive change representing trends towards homogenization, or a negative change representing change towards provincialization. The first plot is for background events and for intervals that directly succeed mass extinction events, so the Olenekian age which does not directly succeed the end-Permian mass extinction event is not included. The second plot investigates change in similarity across three subsequent ages for each of the Late Ordovician Mass Extinction (LOME) and for the end-Permian mass extinction events.\n\n```{r plot, warning = FALSE}\n\n\n# background versus mass extinctions plot:\nall_Jacc_noOlen <- filter(Jacc, !(ID ==\"PT2\" ))\n\nPlot.allJacc <-  all_Jacc_noOlen |> \n  ggplot(aes(x = cutdist, \n             y = Tavg_diff,\n             group = ID, \n             colour = mass)) +     \n  geom_line(linewidth = 1.2, position = position_dodge(width = 0.3)) + \n  ylim(-0.25, 0.25) +\n  geom_hline(yintercept = 0, linewidth = 0.5) + \n  scale_color_manual(values = c(\"grey50\", \"#CC0033\")) +\n\n  labs(\n    x = \"Great Circle Distance (km)\",\n    y = \"Change in Similarity\", \n    colour = \"Extinction type\"\n  ) +\n  theme_light() +\n  geom_ribbon(\n    data = ciband, \n    aes(x = cutdist, ymin = lowci, ymax = upci), \n    fill = \"grey50\", \n    alpha = 0.3, \n    inherit.aes = FALSE, #use this or there will be an error\n  )+\n  theme(aspect.ratio = 1)\nPlot.allJacc\n\nggsave(\"plot.allJacc.pdf\", plot = Plot.allJacc, width = 10, height =6 , units = \"in\", dpi = 300)\n\nall_Jacc3 <- Jacc |>   filter(ID %in% c(\"PT\", \"lome\", \"LOME2\", \"PT2\"))\n\n\n# LOME and PT interval-trio plot: \nPlot.Jacc3 <- all_Jacc3 |> \n  ggplot(aes(x = cutdist, \n             y = Tavg_diff,\n             group = ID, \n             colour = ID)) +     \n  geom_line(linewidth = 1.2, position = position_dodge(width = 0.3)) + ylim(-0.25, 0.25) +\n  geom_hline(yintercept=0, linewidth=0.5) + \nscale_color_manual(values = c( \"chocolate4\",\"tan2\", \"dodgerblue2\",\"skyblue2\")) +\n   geom_ribbon(\n    data = ciband, \n    aes(x = cutdist, ymin = lowci, ymax = upci), \n    fill = \"grey50\", \n    alpha = 0.3, \n    inherit.aes = FALSE\n  )+\nlabs(x = \"Great Circle Distance (km)\",\n     y = \"Change in Similarity\", \n     colour = \"Extinction type\") +\n  theme_light() +\n  theme(plot.title = element_text(face = \"bold\"),\n        axis.title = element_text(face = \"bold\"),\n        legend.title = element_text(face = \"bold\"),\n        aspect.ratio = 1)\nPlot.Jacc3\n\nggsave(\"plot.Jaccwaste-pt.pdf\", plot = Plot.Jacc3, width = 10, height =6 , units = \"in\", dpi = 300)\n\n\n\n```\n","srcMarkdownNoYaml":"\n\n## Setup\n\n```{r setup, message = FALSE, warning = FALSE}\n\nrpkg <- c(\"readr tidyverse fs stringr ggplot2 dplyr conflicted piggyback tidyr tibble downloadthis ggpubr\")\n\n\nimport_pkg <- function(x)\n  x |> trimws() |> strsplit(\"\\\\s+\")  |> unlist() |> \n  lapply(function(x) library(x, character.only = T)) |> \n  invisible()\n\nrpkg |> import_pkg()\n\n# Resolve conflicted functions.\nconflicted::conflict_prefer(name = \"filter\", winner = \"dplyr\",losers = \"stats\")\n\n```\n\n## Multiple csv files\n\nWe begin by loading in the Jaccard .csv files we generated for each interval set in BeforeAfter.R. These files are also readily available for you in the Github Repository under the \"Difference\" folder.\n\nTo calculate the error and in Figure 3, we get the data from our calculations BeforeAfter as well, which is also readily available for you in the folder \"avg_diff\".\n\nRead multiple csv files in and organize them using `fs` to read in all the .csv files at once, as well as `purrr` and `dplyr` from `tidyverse` to organize them. We will do this for the main dataset and also for the grey error band we calculated earlier.\n\n```{r multiple-csv, message = FALSE}\n\n# For main dataset\ndata_dir <- \"~/Documents/BioHom/Difference/\" #setup directory of where we want to read the multiple files. This is simply folder of the sumRes_03 dataframe for each interval-set we've calculated, all collated into one folder. \n\n#For error band\ndata_diff <- \"~/Documents/BioHom/avg_diff/\"\n\n# Test to be sure this works by loading in all. csv files:\ncsv_files <- fs::dir_ls(data_dir, regexp = \"\\\\.csv$\")  # use fs to collect all data in data_dir that ends in .csv\ncsv_files_diff <- fs::dir_ls(data_diff, regexp = \"\\\\.csv$\") # for error\n\n# Now load in the .csv files and ID each .csv to keep tabs:\nall_Jacc <- data_dir |> \n  dir_ls(regexp = \"\\\\.csv$\") |>   # read in all files in the directory that end in .csv\n  map_dfr(read_csv, .id = \"source\")   # id everything by source\n#for errors:\nall_errors <- data_diff |> \n  dir_ls(regexp = \"\\\\.csv$\") |>   # read in all files in the directory that end in .csv\n  map_dfr(read_csv, .id = \"source\")   # id everything by source\n\n# Set up better ID's:\nall_Jacc$ID <- gsub(\".*\\\\/([^\\\\/]*)(Kpg|LOI|PT|TJ|lome|Messi|SanCamp|AlbCen|Pliens|Assel|Serra).*\", \"\\\\2\", all_Jacc$source)\n# ^ add a new column with ID's based on all_Jacc$source, removing all but the interval-pair name from it\n# Set up better ID's:\nall_errors$ID <- gsub(\".*\\\\/([^\\\\/]*)(Alb|Assel|Camp|Ceno|Cha|Dan|Dar|Het|Het|Hir|Ind|Kat|Maa|Messi|Ole|Plie|Rhae|Rhud|Sak|San|Toa|Zanc).*\", \"\\\\2\", all_errors$source)\n\n# Rearrange data for clarity using dplyr's arrange():\nall_Jacc <- all_Jacc |>   arrange(ID, cutdist)\nall_errors <- all_errors|>   arrange(ID, cutdist)\n\nall_Jacc$source <- NULL # remove source column now that it is no longer needed\nall_errors$source <- NULL # remove source column now that it is no longer needed\n\nall_Jacc$...1 <- NULL # remove this weird column that was added in with source as well\nall_errors$...1 <- NULL # remove this weird column that was added in with source as well\n\nall_Jacc$age <- NULL # remove this weird column that was added in with source as well\n\n# Separate the LOME and PT data for later:\n\n# After\nLOME_Jacc <- all_Jacc[all_Jacc$label == 'After' & all_Jacc$ID == 'lome', ]\nPT_Jacc   <- all_Jacc[all_Jacc$label == 'After' & all_Jacc$ID == 'PT', ]\n\n# After-2\nLOME2_Jacc <- all_Jacc[all_Jacc$label == 'After-2' & all_Jacc$ID == 'lome', ]\nPT2_Jacc   <- all_Jacc[all_Jacc$label == 'After-2' & all_Jacc$ID == 'PT', ]\n\n# Add in missing cutdist values:\nmissing_LOME <- data.frame(cutdist=c(18000, 20000),\n                           avg= c(NA, NA), sdev= c(NA, NA), \n                           n= c(NA,NA), se= c(NA,NA), first= c(NA,NA), \n                           second= c(NA, NA), label = c('After-2','After-2'),\n                           ci = c(NA, NA),\n                           ID = c('lome','lome'), Jaccard_change=c(NA,NA))\n\nLOME_Jacc <-rbind(LOME_Jacc, missing_LOME)\nLOME2_Jacc <- rbind(LOME2_Jacc, missing_LOME)\n\n# Add in missing cutdist values:\nmissing_PT <- data.frame(cutdist=c(18000, 18000,20000, 20000),\n                           avg= c(NA, NA, NA, NA),\n                          sdev= c(NA, NA, NA, NA),\n                           n=   c(NA, NA, NA, NA),\n                           se=  c(NA, NA, NA, NA),\n                         first= c(NA, NA, NA, NA),\n                        second= c(NA, NA, NA, NA),\n                        label = c('After','After-2', 'After', 'After-2'),\n                           ci = c(NA, NA, NA, NA),\n                           ID = c('PT','PT','PT', 'PT'),\n                        Jaccard_change=c(NA,NA,NA,NA))\n\nPT2_Jacc <- rbind(PT2_Jacc, missing_PT)\n\nLOME2_Jacc$ID <- 'LOME2' # Give it a unique label\nPT2_Jacc$ID <- 'PT2'\n\nLOME_Jacc <- rbind(LOME_Jacc, LOME2_Jacc) # Bring After and After-2 together\nPT_Jacc <- rbind(PT_Jacc, PT2_Jacc)\n\n\n```\n\n## Before and after columns\n\nAll interval pairs need to have columns from 0 -20000 in order to perform the calculations, so those with missing columns are filled in with NA data. We are separating by the labels Before and After. The goal is to create two new columns, one 'ave_before' and one 'ave_after' so we can subtract one from the other and calculate the change in similarity:\n\n```{r}\n\n# Using dplyr, I add each missing row into a new df: \nmissing <- data.frame(cutdist=c(20000, 20000, # AlbCen\n                                20000, 20000,# Assel\n                                20000, 20000, # LOI\n                                18000, 20000, # lome\n                                20000, 20000, # messi\n                                20000, 20000, # pliens\n                                18000, 18000, 20000, 20000, 20000, # PT\n                                20000, 20000, #SanCamp\n                                18000, 20000,  #Serra\n                                20000), #TJ\n                     avg=    c(NA, NA,\n                               NA, NA,\n                               NA, NA,\n                               NA, NA, \n                               NA, NA,\n                               NA, NA, \n                               NA, NA, NA, NA, NA,\n                               NA, NA,\n                               NA, NA, \n                               NA),\n                     sdev=   c(NA, NA, \n                               NA, NA,\n                               NA, NA,\n                               NA, NA, \n                               NA, NA, \n                               NA, NA, \n                               NA, NA, NA, NA, NA,\n                               NA, NA,\n                               NA, NA, \n                               NA),\n                     n=      c(NA, NA, \n                               NA, NA,\n                               NA, NA,\n                               NA, NA, \n                               NA, NA, \n                               NA, NA,\n                               NA, NA, NA, NA, NA,\n                               NA, NA,\n                               NA, NA, \n                               NA),\n                     se=     c(NA, NA, \n                               NA, NA,\n                               NA, NA,\n                               NA, NA, \n                               NA, NA, \n                               NA, NA,\n                               NA, NA, NA, NA, NA, \n                               NA, NA,\n                               NA, NA, \n                               NA),\n                     first=  c(NA, NA,\n                               NA, NA, \n                               NA, NA,\n                               NA, NA,  \n                               NA, NA, \n                               NA, NA, \n                               NA, NA, NA, NA, NA,\n                               NA, NA,\n                               NA, NA, \n                               NA), \n                     second= c(NA, NA, NA,\n                               NA,\n                               NA, NA, \n                               NA, NA, \n                               NA, NA,\n                               NA, NA, \n                               NA, NA, NA, NA, NA, \n                               NA, NA,\n                               NA, NA, \n                               NA),\n                     label=  c('Before', 'After',\n                               'Before', 'After',\n                               'Before', 'After',\n                               'After-2', 'After-2', \n                               'Before','After', \n                               'Before','After',\n                               'After', 'After-2', 'Before', \"After\", \"After-2\",\n                               'Before','After',\n                               'Before', 'After',\n                               'After'),\n                     ci=    c(NA, NA,\n                              NA, NA,\n                              NA, NA,\n                              NA, NA, \n                              NA, NA, \n                              NA, NA,\n                              NA, NA, NA, NA, NA, \n                              NA,NA,\n                              NA, NA, \n                              NA),\n                     ID =   c('AlbCen', 'AlbCen',\n                              'Assel', 'Assel',\n                              'LOI', 'LOI',\n                              'lome', 'lome',\n                              'Messi','Messi',\n                              'Pliens', 'Pliens', \n                              'PT', 'PT', 'PT', 'PT', 'PT',\n                              'SanCamp','SanCamp',\n                              'Serra', 'Serra',\n                              'TJ'),\n                     Jaccard_change= c(NA, NA,\n                              NA, NA,\n                              NA, NA,\n                              NA, NA, \n                              NA, NA, \n                              NA, NA,\n                              NA, NA, NA, NA, NA, \n                              NA,NA,\n                              NA, NA, \n                              NA))\n\n# Add these missing rows to the all_Jacc df\nall_Jacc <- rbind(all_Jacc, missing)\n\n# Rearrange all_Jacc by ID and cutDist and label\nall_Jacc <- all_Jacc |> \n            arrange(ID, cutdist, label)\n\n\n```\n\n## Difference\n\nSeparate the data to separate before and after columns so we can subtract them:\n\n```{r, message = FALSE }\n\n# Remove After-2\nall_Jacc2 <- all_Jacc |> \n  filter(!label == 'After-2')\n\n# Before: \nbefore_data2 = \n  all_Jacc2 |>\n  filter(label == 'Before') |> \n  group_by(cutdist,ID) |>\n  mutate(ave_before = avg) |> \n  mutate(ave_first_b= first) |> \n  mutate(ave_second_b = second) |>\n  select(c(ave_before ))\n\n# After:\nafter_data2 = \n  all_Jacc2 |>\n  filter(label == 'After') |> \n  group_by(cutdist,ID) |>\n  mutate(ave_after = avg) |>\n    mutate(ave_first= first) |> \n  mutate(ave_second = second) |> #change the name to avg \n  select(c(ave_after)) # only these columns are selected\n\nbefore_data2 <- na.omit(before_data2)\nafter_data2 <- na.omit(after_data2)\n\n# Add the after_data to before_data:\nall_Jacc_diff2 <- left_join(after_data2, before_data2, by=c(\"cutdist\", \"ID\"))\n\n# Calculate the differences for avg:\nall_Jacc_diff<- all_Jacc_diff2 |> \n  mutate(Tavg_diff = ave_after - ave_before )  \n\n```\n\n## The interval-trio problem\n\nSince the LOME and PT have three intervals that we are analyzing, we need to treat it differently so we can calculate the difference. We will do much of what was done in the previous chunk to After-2 and apply it to find the difference between that and the After column.\n\n```{r LOME-2, message = FALSE }\n# Before: \nbefore_LOME = \n  LOME_Jacc |>\n  filter(label == 'After') |> \n  group_by(cutdist,ID) |>\n mutate(ave_before = avg) |>\n #change the name to avg \n  select(ave_before)\n\nbefore_PT = \n  PT_Jacc |>\n  filter(label == 'After') |> \n  group_by(cutdist,ID) |>\n mutate(ave_before = avg) |>\n select(ave_before)\n\n# After:\nafter_LOME = \n  LOME2_Jacc |>\n  group_by(cutdist,ID) |>\n  filter(label == 'After-2') |> \n mutate(ave_after = avg) |>\n #change the name to avg \n    ungroup() |> \n  select(ave_after) # only this column is selected\n\nafter_PT = \n  PT_Jacc |>\n  group_by(cutdist,ID) |>\n  filter(label == 'After-2') |> \n mutate(ave_after = avg) |>\nungroup() |> \n  select(ave_after) # only this column is selected\n\n# Add the after_data to before_data:\nLOME_Jacc <- cbind(before_LOME,after_LOME)\nLOME_Jacc$ID <- 'LOME2'\n\nPT_Jacc <- cbind(before_PT, after_PT)\nPT_Jacc$ID <- 'PT2'\n\n# Calculate the differences for avg:\nLOME_Jacc<- LOME_Jacc |> \n  mutate(Tavg_diff = ave_after - ave_before ) \n\n\nJacc <- rbind(all_Jacc_diff,LOME_Jacc)\n\nPT_Jacc <- PT_Jacc |> \n  mutate(Tavg_diff = ave_after - ave_before ) \n\nJacc <- rbind(Jacc,PT_Jacc)\n\n\n# Add a label to determine whether an interval is a mass extinction or background interval:\n\nJacc$mass <- NA\n\n#Using stringr's str_detect and dplyr's mutate, we can do this:\nJacc <- Jacc |> \n  mutate(mass = case_when(str_detect(ID, \"(lome|LOME2|PT|PT2|TJ|Kpg)$\")~ \"mass\", TRUE ~ \"background\")) #all else are labeled background\n```\n\nNow, here is the final dataset with all interval pairs and trios!\n\n```{r}\nJacc\n\n\n```\n\n## Finding the \"no-change\" zone\n\nFor this particular set of plots, we are going to want the dataframes of when we compare each age to itself (Changhsingian-to-Changhsingian, for example) instead of comparing before and after. Luckily, we already calculated that in the previous set of codes (`before_after.R`). From that code, we are interested in looking at the dataframes for each age that stored all our calculated similarity values for each iteration of our subsamples per age. We loaded that dataset in earlier in this script and labeled it *all_errors*, which gives the age as well as the maximumum and minimum values of those differences.\n\n```{r errordata}\nall_errors\n\n```\n\nTo calculate the \"band of no-change\", We want to use the average of the upper and lower 95% confidence intervals for each distance bin (labeled as *cut_dist* here) across all the ages.\n\n```{r read-sumRes}\n# Upper 95 confidence interval:\nave_up95ci <- all_errors |>\n  group_by(cutdist) |>\n  summarise(upci = mean(upper_95, na.rm = TRUE)) |> \n  ungroup()\n\n# Lowe 95 confidence interval:\nave_low95ci <- all_errors |>\n  group_by(cutdist) |>\n  summarise(lowci = mean(lower_95, na.rm = TRUE)) |> \n  ungroup()\n\nciband <- left_join(ave_up95ci,ave_low95ci, by = \"cutdist\")\nciband$cutdist[is.na(ciband$cutdist)] <- 20000\n\n\n\nciband\n\n```\n\n## Plot it out\n\nHere we create two plots to examine the change in similarity for each interval pair (or trio), as either a positive change representing trends towards homogenization, or a negative change representing change towards provincialization. The first plot is for background events and for intervals that directly succeed mass extinction events, so the Olenekian age which does not directly succeed the end-Permian mass extinction event is not included. The second plot investigates change in similarity across three subsequent ages for each of the Late Ordovician Mass Extinction (LOME) and for the end-Permian mass extinction events.\n\n```{r plot, warning = FALSE}\n\n\n# background versus mass extinctions plot:\nall_Jacc_noOlen <- filter(Jacc, !(ID ==\"PT2\" ))\n\nPlot.allJacc <-  all_Jacc_noOlen |> \n  ggplot(aes(x = cutdist, \n             y = Tavg_diff,\n             group = ID, \n             colour = mass)) +     \n  geom_line(linewidth = 1.2, position = position_dodge(width = 0.3)) + \n  ylim(-0.25, 0.25) +\n  geom_hline(yintercept = 0, linewidth = 0.5) + \n  scale_color_manual(values = c(\"grey50\", \"#CC0033\")) +\n\n  labs(\n    x = \"Great Circle Distance (km)\",\n    y = \"Change in Similarity\", \n    colour = \"Extinction type\"\n  ) +\n  theme_light() +\n  geom_ribbon(\n    data = ciband, \n    aes(x = cutdist, ymin = lowci, ymax = upci), \n    fill = \"grey50\", \n    alpha = 0.3, \n    inherit.aes = FALSE, #use this or there will be an error\n  )+\n  theme(aspect.ratio = 1)\nPlot.allJacc\n\nggsave(\"plot.allJacc.pdf\", plot = Plot.allJacc, width = 10, height =6 , units = \"in\", dpi = 300)\n\nall_Jacc3 <- Jacc |>   filter(ID %in% c(\"PT\", \"lome\", \"LOME2\", \"PT2\"))\n\n\n# LOME and PT interval-trio plot: \nPlot.Jacc3 <- all_Jacc3 |> \n  ggplot(aes(x = cutdist, \n             y = Tavg_diff,\n             group = ID, \n             colour = ID)) +     \n  geom_line(linewidth = 1.2, position = position_dodge(width = 0.3)) + ylim(-0.25, 0.25) +\n  geom_hline(yintercept=0, linewidth=0.5) + \nscale_color_manual(values = c( \"chocolate4\",\"tan2\", \"dodgerblue2\",\"skyblue2\")) +\n   geom_ribbon(\n    data = ciband, \n    aes(x = cutdist, ymin = lowci, ymax = upci), \n    fill = \"grey50\", \n    alpha = 0.3, \n    inherit.aes = FALSE\n  )+\nlabs(x = \"Great Circle Distance (km)\",\n     y = \"Change in Similarity\", \n     colour = \"Extinction type\") +\n  theme_light() +\n  theme(plot.title = element_text(face = \"bold\"),\n        axis.title = element_text(face = \"bold\"),\n        legend.title = element_text(face = \"bold\"),\n        aspect.ratio = 1)\nPlot.Jacc3\n\nggsave(\"plot.Jaccwaste-pt.pdf\", plot = Plot.Jacc3, width = 10, height =6 , units = \"in\", dpi = 300)\n\n\n\n```\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"number-sections":false,"reference-location":"margin","highlight-style":"pygments","html-math-method":"katex","embed-resources":true,"output-file":"03_Fig3.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.8.26","title":"Generating Figure 3","title-block-banner":"#014240","title-block-banner-color":"#FFFFFF","date":"last-modified","date-format":"YYYY-MM-DD","mainfont":"Figtree","sansfont":"Figtree","footnotes-hover":true,"crossref":{"chapters":true},"author":[{"name":"Anonymous","url":"https://github.com/Anonymous-paleobio"}],"fig-cap-location":"top","editor_options":{"chunk_output_type":"console"},"toc-expand":5,"toc-location":"left"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}